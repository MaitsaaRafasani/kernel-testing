type: tcp
message_type: hex
device_type: teltonika
nsq_check: true

test_case:
  - name: Teltonika FMB130 Unregistered device
    connections:
      - steps:
        - name: Login
          pre_test:
            - $template: delete_device
              args: ["${imei}"]
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "000f${imei_hex}"
          expect_ack: 
            - "01"
            - "000000000000000e0c010500000006676574766572010000a4c2"
          nsq_check: []

        - name: Model identifier
          send: "000000000000009e0c0106000000965665723a30342e30302e30305f3133204750533a41584e5f352e312e392048773a464d42313330204d6f643a343520494d45493a33353337343233373239353030343820496e69743a323032352d31312d313020383a343920557074696d653a353239204d41433a333838413231373845303143205350433a312830292041584c3a32204f42443a3020424c3a312e31302042543a34010000953d"
          expect_ack: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", 0, True, "${date_now}"]
          nsq_check: []

        - name: AVL packet target 0
          send: "000000000000006c8e010000019a6cfcd7c8004334551dfbaad4690018013f06000000000011000700ef0100f00100150500c800004501000101007160000700b5001700b6001500425f4700cd7de900ce3e990043101e0044002c000300f10000c74200c70000016200100002438200000000010000e857"
          expect_ack:
            - '00000001'
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", 0, False, "${date_now}"]
          nsq_check: []

  - name: Teltonika Login target 0
    connections:
      - steps:
        - name: Login
          pre_test:
            - $template: insert_device
              args: ["${imei}", "teltonika", "fmb130", 0]
          send: "000f${imei_hex}"
          expect_ack: []
          nsq_check: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", 0, false, ""]

  - name: New teltonika FM1200 registered device
    connections:
      - steps:
        - name: Login
          pre_test: 
            - $template: insert_device
              args: ["${imei}", None, None, "${target_nsq_debug}"]
          send: "000f${imei_hex}"
          expect_ack:
            - "01"
          nsq_check: []

      - name: AVL packet 1
        send: "00000000000003b5080b0000019a4a618b50013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a619320013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a619352013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61cdb8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61e528013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61fc98013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a620468013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a621fc0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a622f60013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab5000ab600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a623348013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50009b600054235c7180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a623730013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b00003bd4"
        expect_ack:
          - '0000000b'
        nsq_check: []

      - name: AVL packet 2
        send: "00000000000003b5080b0000019a4a625288013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a626228013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6269f8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a627d80013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62b818013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62bfe8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62cf88013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62d370013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62eae0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62eec8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a630a20013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b0000937f"
        expect_ack:
          - '0000000b'
        nsq_check: []

      - name: Model identifier
        send: "00000000000000940c01060000008c4657205665723a30312e30362e313520523020494d45493a3335373435343037353036323337302044657669636549443a30303030303920424c205665723a30342e3032204d6f64656d204657205665723a544d3131515f525f30312e30342e30372e30305f3030312048573a464d313230322e5265763078204e694d482c20362d333056205447313030300100003524"
        expect_ack:
          - '00000001'
        nsq_check: []

      - name: AVL packet 3
        send: "00000000000003b5080b0000019a4a6311f0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a631222013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c7180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a631254013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c6180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6315d8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c5180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a63160a013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c4180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6319c0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a634c88013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50008b600054235c2180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a635458013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6363f8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c2180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a63642a013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a636bc8013fae2f3efc4f81f60039000014000042130701010200b3004501f000500415040909000ab50008b600054235c4180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b00009041"
        expect_ack:
          - '00000001'
        nsq_check:
          - $template: nsq_data
            args: ["${imei}", "00000000000003b5080b0000019a4a618b50013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a619320013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a619352013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50009b600064235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61cdb8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61e528013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a61fc98013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a620468013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a621fc0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a622f60013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab5000ab600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a623348013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50009b600054235c7180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a623730013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b00003bd4", "fmb130", "teltonika"]
          - $template: nsq_data
            args: ["${imei}", "00000000000003b5080b0000019a4a625288013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a626228013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6269f8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a627d80013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62b818013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62bfe8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62cf88013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62d370013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62eae0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a62eec8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235ca180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a630a20013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c9180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b0000937f", "fmb130", "teltonika"]
          - $template: nsq_data
            args: ["${imei}", "00000000000003b5080b0000019a4a6311f0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c8180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a631222013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c7180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a631254013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c6180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6315d8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c5180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a63160a013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c4180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6319c0013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a634c88013fae2f3efc4f81f6002e000013000042130701010200b3004501f000500415040909000ab50008b600054235c2180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a635458013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a6363f8013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c2180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a63642a013fae2f3efc4f81f6002e000014000042130701010200b3004501f000500415040909000ab50008b600054235c3180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000000019a4a636bc8013fae2f3efc4f81f60039000014000042130701010200b3004501f000500415040909000ab50008b600054235c4180000cd2a98ce0506430e3d4400000346000000ebc700000000f10000c742000b00009041", "fmb130", "teltonika"]

  - name: Teltonika FMB130 Registered device
    connections:
      - steps:
        - name: Login
          pre_test: 
            - $template: insert_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}"]
          send: "000f${imei_hex}"
          expect_ack:
            - "01"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "000f${imei_hex}", "fmb130", "teltonika"]

        - name: Location
          send: "000000000000006c8e010000019a6cfd35880043345146fbaad5950017014806000000000011000700ef0100f00100150500c800004501000101007160000700b5001700b6001400425f6100cd7de900ce3e990043101e0044002b000300f10000c74200c700000171001000024391000000000100002e2f"
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "000000000000006c8e010000019a6cfd35880043345146fbaad5950017014806000000000011000700ef0100f00100150500c800004501000101007160000700b5001700b6001400425f6100cd7de900ce3e990043101e0044002b000300f10000c74200c700000171001000024391000000000100002e2f", "fmb130", "teltonika"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}", true, "${date_now}"]

        - name: ICCID
          send: "00000000000000380c010600000030494d45493a203335333734323337323935303034382c20434349443a2038393632313030303937393036333134353738010000ce47"
          expect_ack:
            - ""
          db_check:
            - $template: db_check_device_iccid
              args: ["${imei}", "8962100097906314578", "${date_now}"]
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "00000000000000380c010600000030494d45493a203335333734323337323935303034382c20434349443a2038393632313030303937393036333134353738010000ce47", "fmb130", "teltonika"]

        - name: Location
          send: "000000000000006c8e010000019a6cfd5c9800433450b0fbaad8510017013306000000000011000700ef0100f00100150500c800004501000101007161000700b5001600b6001400425f7100cd7de900ce3e990043101f0044002b000300f10000c74200c700000171001000024391000000000100007797"
          expect_ack:
            - ""
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "000000000000006c8e010000019a6cfd35880043345146fbaad5950017014806000000000011000700ef0100f00100150500c800004501000101007160000700b5001700b6001400425f6100cd7de900ce3e990043101e0044002b000300f10000c74200c700000171001000024391000000000100002e2f", "fmb130", "teltonika"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}", false, "${date_now}"]

  - name: Teltonika Buffer
    connections:
      - steps:
        - name: Login
          pre_test: 
            - $template: insert_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}"]
          send: "000f${imei_hex}"
          expect_ack:
            - "01"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "000f${imei_hex}", "fmb130", "teltonika"]

        - name: Location Buffer
          send: ""
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}", true, "${date_now}"]

        - name: Location Buffer 2
          send: ""
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}", true, "${date_now}"]

  - name: Teltonika FMB130 Online command
    connections:
      - steps:
        - name: Login
          block: true
          pre_test: 
            - $template: insert_device
              args: ["${imei}", "teltonika", "fmb130", "${target_nsq_debug}"]
            - $template: reset_command_queue
              args: ["${imei}"]
          send: ""
          expect_ack:
            - ""
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "", "teltonika", "fmb130"]

        - name: Location
          block: true
          send: ""
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]

        - name: Command reply message
          send: ""
          expect_ack: []
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
              expected_failed: true   # cause running paralel with login, we dont know wich one received by gate

        - name: Heartbeat
          send: ""
          expect_ack:
            - ""
            - ""
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "", "fmb130", "teltonika"]
              expected_failed: true   # cause running paralel with login, we dont know wich one received by gate

      - steps:
        - delay: 2
        - name: Send online command
          pre_test:
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "80800${imei}0753544154555323"
          expect_ack: []
          db_check:
            - $template: db_check_command_queue
              args: ["${imei}", false]