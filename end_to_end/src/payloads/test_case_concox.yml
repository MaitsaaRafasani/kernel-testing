type: tcp
message_type: hex
device_type: concox
nsq_check: true

test_case:
  - name: Concox X3 Unregistered device
    connections:
      - steps:
        - name: Login
          pre_test:
            - $template: delete_device
              args: ["${imei}"]
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "787811010${imei}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
            - "787812800c0000000056455253494f4e231011e1b50d0a"
            - "787813800b0000000056455253494f4e00021011da780d0a"
          nsq_check: []

        - name: Location packet
          send: "7878222219080a102021c700c7a6200c18caa000d03301fe0a3e990096f40100010022f95d0d0a"
          expect_ack: []
          nsq_check: []

        - name: Model identifier
          send: "797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a"
          expect_ack: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", 0, True, "${date_now}"]
          nsq_check: []

        - name: Location packet target 0
          send: "7878222219080a102022c700c7a6200c18caa000d03301fe0a3e990096f40100010022f95d0d0a"
          expect_ack: []
          nsq_check: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", 0, false, "${date_now}"]

  - name: Concox X3 Login target 0
    connections:
      - steps:
        - name: Login
          pre_test:
            - $template: insert_device
              args: ["${imei}", "concox", "x3", 0]
          send: "787811010${imei}200812c90410f40e0d0a"
          expect_ack: []
          nsq_check: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", 0, false, ""]

  - name: Concox X3 Registered device
    connections:
      - steps:
        - name: Login
          pre_test: 
            - $template: insert_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}"]
          send: "787811010${imei}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "787811010${imei}200812c90410f40e0d0a", "x3", "concox"]

        - name: Location
          send: "7878222219080b140603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a"
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "7878222219080b140603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a", "x3", "concox"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}", true, "${date_now}"]

        - name: Heartbeat
          send: "78780a130604040002000d8f530d0a"
          expect_ack:
            - "7878051310017c600d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "78780a130604040002000d8f530d0a", "x3", "concox"]

        - name: ICCID
          send: ""
          expect_ack:
            - ""
          db_check:
            - $template: db_check_device_iccid
              args: ["${imei}", "", "${date_now}"]

        - name: Alarm Vibration
          send: "7878252612030c063816c3026c10540c38c9700144030901cc002866000eee0c06040302000da2db0d0a"
          expect_ack:
            - "787805261001c3730d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "7878252612030c063816c3026c10540c38c9700144030901cc002866000eee0c06040302000da2db0d0a", "x3", "concox"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}", false, "${date_now}"]

  - name: Concox JC400 Registered new trackvision device
    connections:
      - steps:
        - name: Login
          pre_test: 
            - $template: insert_device
              args: ["${imei_trackvision}", None, None, "${target_nsq_debug}"]
          send: "787811010${imei_trackvision}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
            - "787812800c0000000056455253494f4e231011e1b50d0a"
            - "787813800b0000000056455253494f4e00021011da780d0a"
          nsq_check: []

        - name: Model identifier - change target to trackvision
          send: "7979003d2100000000015b56455253494f4e5d4b4d4332385f4a433430305f574142415f5354445f56342e342e312e31325f3234313130322e313533310834fbae0d0a"
          expect_ack: []
          nsq_check: []
          db_check:
            - $template: db_check_device
              args: ["${imei_trackvision}", "concox", "jc400-c", "${target_trackvision}", false, "${date_now}"]

  - name: Concox X3 Buffer
    connections:
      - steps:
        - name: Buffer - login
          pre_test:
            - $template: insert_device
              args: ["${imei}", None, None, "${target_nsq_debug}"]
          send: "787811010${imei}200812c90410f40e0d0a787811010${imei}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
            - "7878050110014c4d0d0a"
            - "787812800c0000000056455253494f4e231011e1b50d0a"
            - "787813800b0000000056455253494f4e00021011da780d0a"
          nsq_check: []

        - name: Buffer - model identifier + location
          send: "7878222219080a102021c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a"
          expect_ack: []
          nsq_check: []
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}", true, "${date_now}"]

        - name: Buffer - Location
          send: "7878222219080b150603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a7878222219080b160603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a7878222219080b160603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a"
          expected_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "7878222219080a102021c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a", "x3", "concox"]
            - $template: nsq_data
              args: ["${imei}", "7878222219080b150603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a7878222219080b160603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a7878222219080b160603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a", "x3", "concox"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}", true, "${date_now}"]

        - name: Buffer - heartbeat + location + alarm
          send: |
            7878222219080a102029c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a
            78780a130604040002000d8f530d0a
            7878222219080a102030c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a
            7878252612030c063816c3026c10540c38c9700144030901cc002866000eee0c06040302000da2db0d0a
          expected_ack: 
            - "7878051310017c600d0a"
            - "787805261001c3730d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "7878222219080a102029c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a78780a130604040002000d8f530d0a7878222219080a102030c700c7a6200c19caa000d03301fe0a3e990096f40100010022f95d0d0a7878252612030c063816c3026c10540c38c9700144030901cc002866000eee0c06040302000da2db0d0a", "x3", "concox"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
          db_check:
            - $template: db_check_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}", false, "${date_now}"]

  - name: Concox X3 Online command
    connections:
      - steps:
        - name: Login
          block: true
          pre_test: 
            - $template: insert_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}"]
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "787811010${imei}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "787811010${imei}200812c90410f40e0d0a", "x3", "concox"]

        - name: Location
          block: true
          send: "7878222219080b140603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a"
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "7878222219080b140603c800c7a5d10c18c86000d11501fe0a3e990096f4010001002208be0d0a", "x3", "concox"]

        - name: Command reply message
          send: "797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a"
          expect_ack: []
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a", "x3", "concox"]
            - $template: nsq_data
              args: ["${imei}", "79790029210022000000737563636573732120636f6d6d616e642073656e74202d20535441545553231011019e0d0a", "x3", "concox"]
              expected_failed: true   # cause running paralel with login, we dont know wich one received by gate

        - name: Heartbeat
          send: "78780a130604040002000d8f530d0a"
          expect_ack:
            - "787811800b00000000535441545553231011e78b0d0a"
            - "7878051310017c600d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "78780a130604040002000d8f530d0a", "x3", "concox"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "79790029210022000000737563636573732120636f6d6d616e642073656e74202d20535441545553231011019e0d0a", "x3", "concox"]
              expected_failed: true   # cause running paralel with login, we dont know wich one received by gate

      - steps:
        - delay: 2
        - name: Send online command
          pre_test:
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "80800${imei}0753544154555323"
          expect_ack: []
          db_check:
            - $template: db_check_command_queue
              args: ["${imei}", false]

  - name: Concox X3 Online command, device offline
    connections:
      - steps:
        - name: Send online command
          pre_test:
            - $template: reset_command_queue
              args: ["${imei}"]
          send: "80800${imei}0753544154555323"
          expect_ack: []
          db_check:
          - delay: 3
          - $template: db_check_command_queue
            args: ["${imei}", true, "80800${imei}0753544154555323", "${date}"]
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "7979003121002a000000696e71756575652120646576696365206e6f7420636f6e6e6563746564202d20535441545553231011fed90d0a", "x3", "concox"]

  - name: Concox X3 Login, send command queue
    connections:
      - steps:
        - name: Login
          pre_test:
            - $template: insert_device
              args: ["${imei}", "concox", "x3", "${target_nsq_debug}"]
          send: "787811010${imei}200812c90410f40e0d0a"
          expect_ack:
            - "7878050110014c4d0d0a"
            # online command receive by device
            - "787811800b00000000535441545553231011e78b0d0a"
          nsq_check:
            - $template: nsq_data
              args: ["${imei}", "787811010${imei}200812c90410f40e0d0a", "x3", "concox"]
            - $template: nsq_data
              args: ["${imei}", "7979003f210038000000636f6d6d616e6420696e2071756575652c20636f6d6d616e64207375636365737366756c6c792073656e74202d20535441545553231011b70a0d0a", "x3", "concox"]

        - name: Command reply message
          send: "797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a"
          expect_ack: []
          nsq_check:
            - $template: nsq_connection_info_connect
              args: ["${imei}"]
            - $template: nsq_data
              args: ["${imei}", "797900332100000000015b56455253494f4e5d4e5433375f47543831305f574141445f56332e315f3232303930372e313631380029fdbe0d0a", "x3", "concox"]
            - $template: nsq_connection_info_disconnect
              args: ["${imei}"]
